<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ramadan Quiz Challenge</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: #000;
            color: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
        }

        .container {
            width: 100%;
            height: 100vh;
            background: radial-gradient(ellipse at top, #1a0a2e 0%, #0d1b3e 40%, #0a0f1e 100%);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .stars { position: absolute; inset: 0; pointer-events: none; z-index: 0; }
        .star {
            position: absolute;
            background: #fff;
            border-radius: 50%;
            animation: twinkle var(--d) ease-in-out infinite alternate;
        }
        @keyframes twinkle {
            from { opacity: 0.1; transform: scale(0.8); }
            to   { opacity: 1;   transform: scale(1.2); }
        }

        .moon {
            position: absolute;
            top: 10px; right: 16px;
            width: 56px; height: 56px;
            z-index: 2;
            filter: drop-shadow(0 0 12px rgba(255,215,80,.8));
        }

        .lantern {
            position: absolute;
            top: 54px;
            font-size: 2rem;
            z-index: 2;
            animation: swing 3s ease-in-out infinite alternate;
            transform-origin: top center;
        }
        .lantern-l { left: 14px; }
        .lantern-r { right: 14px; animation-direction: alternate-reverse; }
        @keyframes swing {
            from { transform: rotate(-8deg); }
            to   { transform: rotate(8deg);  }
        }

        .mosque {
            position: absolute;
            bottom: 0; left: 0;
            width: 100%; height: 75px;
            pointer-events: none;
            z-index: 0;
            opacity: .15;
        }

        .question-number {
            position: absolute;
            top: 12px; left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg,#7c3800,#c87000,#f5c518,#c87000,#7c3800);
            padding: 7px 20px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 1.15rem;
            box-shadow: 0 0 14px rgba(212,160,23,.7), inset 0 0 6px rgba(0,0,0,.3);
            z-index: 10;
            border: 2px solid #ffe066;
            min-width: 150px;
            text-align: center;
            color: #fff;
            text-shadow: 1px 1px 3px #000;
            letter-spacing: .5px;
            white-space: nowrap;
        }

        .ramadan-header {
            position: absolute;
            top: 50px; left: 50%;
            transform: translateX(-50%);
            font-size: .66rem;
            color: #ffe066;
            letter-spacing: 2px;
            text-transform: uppercase;
            opacity: .7;
            white-space: nowrap;
            z-index: 3;
            text-shadow: 0 0 8px rgba(212,160,23,.8);
        }

        .watermark-bg {
            position: absolute;
            inset: 0;
            pointer-events: none;
            z-index: 0;
            overflow: hidden;
            border-radius: 18px;
        }
        .watermark-bg::before {
            content: '@barakah.charity.gm  â€¢  @barakah.charity.gm  â€¢  @barakah.charity.gm  â€¢  @barakah.charity.gm  â€¢  @barakah.charity.gm';
            position: absolute;
            top: -30px; left: -40px;
            width: 200%; height: 200%;
            color: rgba(255,220,80,0.07);
            font-size: .75rem;
            font-weight: 900;
            letter-spacing: 4px;
            word-spacing: 12px;
            white-space: pre-wrap;
            word-break: break-all;
            transform: rotate(-30deg);
            line-height: 2.8rem;
            pointer-events: none;
            user-select: none;
        }

        .card-header-bar {
            width: calc(100% + 30px);
            margin: -15px -15px 14px -15px;
            background: linear-gradient(90deg,
                rgba(212,160,23,0.18) 0%,
                rgba(212,160,23,0.28) 40%,
                rgba(212,160,23,0.18) 100%);
            border-bottom: 1px solid rgba(212,160,23,0.4);
            padding: 6px 14px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            position: relative;
            z-index: 2;
            border-radius: 18px 18px 0 0;
        }

        .timer-wrap {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .timer-container {
            width: 100%;
            height: 8px;
            background: rgba(255,255,255,.12);
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid rgba(212,160,23,.3);
        }
        .timer {
            height: 100%;
            background: linear-gradient(90deg,#ffe066,#f5a623);
            width: 100%;
            transition: width 7s linear;
            border-radius: 8px;
        }
        .timer.paused  { transition: none; }
        .timer.ending  { background: linear-gradient(90deg,#ff4444,#ff0000); }

        .handle-tag {
            font-size: .72rem;
            font-weight: 900;
            color: #ffe066;
            letter-spacing: 1.5px;
            text-shadow: 0 0 8px rgba(212,160,23,.9), 0 0 2px #000;
            white-space: nowrap;
            user-select: none;
            flex-shrink: 0;
        }

        .countdown {
            width: 32px; height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg,#7c3800,#c87000);
            border: 2px solid #ffe066;
            display: flex; align-items: center; justify-content: center;
            font-size: 1rem; font-weight: bold;
            color: #fff; text-shadow: 1px 1px 2px #000;
            flex-shrink: 0;
        }
        .countdown.hidden { display: none; }

        .question-container {
            width: 90%;
            margin-top: 72px;
            height: calc(100% - 152px);
            display: flex;
            flex-direction: column;
            align-items: center;
            background: linear-gradient(160deg,rgba(10,20,60,.9) 0%,rgba(30,10,60,.9) 100%);
            border-radius: 18px;
            padding: 15px;
            box-shadow: 0 0 25px rgba(212,160,23,.35), 0 0 60px rgba(100,0,150,.2);
            border: 1.5px solid rgba(212,160,23,.5);
            position: relative;
            transition: transform .5s, opacity .5s;
            overflow: hidden;
            z-index: 5;
        }

        .question-container::before,
        .question-container::after {
            content: 'âœ¦';
            position: absolute;
            font-size: 1.3rem;
            color: rgba(212,160,23,.5);
            top: 56px;
        }
        .question-container::before { left: 14px; }
        .question-container::after  { right: 14px; }

        .question {
            font-size: 1.45rem;
            font-weight: bold;
            margin: 8px 0 18px;
            text-align: center;
            text-shadow: 2px 2px 5px rgba(0,0,0,.9);
            padding: 0 10px;
            color: #fff;
            line-height: 1.38;
            position: relative;
            z-index: 2;
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .options {
            display: flex;
            flex-direction: column;
            gap: 11px;
            width: 100%;
            position: relative;
            z-index: 2;
        }

        .option {
            background: linear-gradient(135deg,rgba(60,20,100,.7),rgba(10,20,80,.7));
            border: 1.5px solid rgba(212,160,23,.5);
            color: #fff;
            padding: 14px;
            border-radius: 12px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all .25s;
            font-weight: bold;
            text-align: center;
            text-shadow: 1px 1px 2px rgba(0,0,0,.6);
        }
        .option:active { transform: scale(.98); background: rgba(212,160,23,.2); }
        .option.correct {
            background: linear-gradient(135deg,#1a7a2e,#27ae60);
            border-color: #2ecc71;
            box-shadow: 0 0 12px rgba(46,204,113,.6);
        }
        .option.incorrect {
            background: linear-gradient(135deg,#7a1a1a,#c0392b);
            border-color: #e74c3c;
            box-shadow: 0 0 12px rgba(231,76,60,.6);
        }

        .card-footer-bar {
            width: calc(100% + 30px);
            margin: 14px -15px -15px -15px;
            background: linear-gradient(90deg,
                rgba(212,160,23,0.12) 0%,
                rgba(212,160,23,0.22) 50%,
                rgba(212,160,23,0.12) 100%);
            border-top: 1px solid rgba(212,160,23,.35);
            padding: 5px 14px;
            text-align: center;
            font-size: .65rem;
            font-weight: 800;
            color: rgba(255,220,80,.55);
            letter-spacing: 3px;
            text-transform: uppercase;
            user-select: none;
            position: relative;
            z-index: 2;
            border-radius: 0 0 18px 18px;
        }

        .question-container.exit  { transform: translateX(-100%); opacity: 0; }
        .question-container.enter { transform: translateX(100%);  opacity: 0; }

        /* iOS unlock tap overlay â€” shown until audio is unlocked */
        #tap-to-start {
            position: fixed;
            inset: 0;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.82);
            gap: 18px;
            cursor: pointer;
        }
        #tap-to-start .moon-icon { font-size: 3.5rem; animation: pulse 1.6s ease-in-out infinite alternate; }
        @keyframes pulse { from { transform: scale(1); } to { transform: scale(1.12); } }
        #tap-to-start .tap-label {
            font-size: 1.4rem;
            font-weight: 800;
            color: #ffe066;
            text-shadow: 0 0 18px rgba(212,160,23,.9);
            letter-spacing: 1px;
            text-align: center;
            padding: 0 30px;
        }
        #tap-to-start .tap-sub {
            font-size: .85rem;
            color: rgba(255,220,80,.6);
            letter-spacing: 2px;
            text-transform: uppercase;
        }
        #tap-to-start.hidden { display: none; }
    </style>
</head>
<body>

<!-- â”€â”€ iOS Audio Unlock Overlay â”€â”€ -->
<div id="tap-to-start">
    <div class="moon-icon">ðŸŒ™</div>
    <div class="tap-label">Tap to Start the<br>Ramadan Quiz!</div>
    <div class="tap-sub">Tap anywhere to begin</div>
</div>

<div class="container">

    <div class="stars" id="stars"></div>

    <svg class="moon" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
        <defs>
            <radialGradient id="mg" cx="40%" cy="40%" r="60%">
                <stop offset="0%"   stop-color="#fff9c4"/>
                <stop offset="100%" stop-color="#f5a623"/>
            </radialGradient>
        </defs>
        <circle cx="52" cy="50" r="38" fill="url(#mg)"/>
        <circle cx="72" cy="40" r="33" fill="#0d1b3e"/>
    </svg>

    <div class="lantern lantern-l">ðŸª”</div>
    <div class="lantern lantern-r">ðŸª”</div>

    <svg class="mosque" viewBox="0 0 800 80" preserveAspectRatio="xMidYMax meet" xmlns="http://www.w3.org/2000/svg">
        <path fill="white" d="M0,80 L0,55 L30,55 L30,35 L50,35 L50,25 Q60,5 70,25 L70,35 L90,35 L90,55 L120,55 L120,40 L140,40 L140,30 L160,30 L160,20 Q175,0 190,20 L190,30 L210,30 L210,40 L230,40 L230,55 L280,55 L280,40 L300,40 L300,30 L320,30 L320,20 Q340,0 360,20 L360,30 L380,30 L380,40 L400,40 L400,55 L450,55 L450,30 L470,30 L470,20 Q490,0 510,20 L510,30 L530,30 L530,55 L570,55 L570,40 L590,40 L590,30 L610,30 L610,20 Q625,2 640,20 L640,30 L660,30 L660,40 L680,40 L680,55 L710,55 L710,35 L730,35 L730,25 Q740,5 750,25 L750,35 L770,35 L770,55 L800,55 L800,80 Z"/>
    </svg>

    <div class="question-number" id="question-number">Question: 1/10</div>
    <div class="ramadan-header">ðŸŒ™ Ramadan Mubarak ðŸŒ™</div>

    <div class="question-container" id="question-container">

        <div class="watermark-bg"></div>

        <div class="card-header-bar">
            <span class="handle-tag">@barakah.charity.gm</span>
            <div class="timer-wrap">
                <div class="timer-container">
                    <div class="timer paused" id="timer"></div>
                </div>
            </div>
            <div class="countdown hidden" id="countdown">7</div>
        </div>

        <div class="question" id="question">Loadingâ€¦</div>
        <div class="options" id="options"></div>

        <div class="card-footer-bar">ðŸŒ™ &nbsp; @barakah.charity.gm &nbsp; â€¢ &nbsp; Ramadan Mubarak &nbsp; ðŸŒ™</div>

    </div>
</div>

<script>
/* â”€â”€ Starfield â”€â”€ */
(function () {
    const c = document.getElementById('stars');
    for (let i = 0; i < 80; i++) {
        const s = document.createElement('div');
        s.className = 'star';
        const z = Math.random() * 2.5 + 0.5;
        s.style.cssText = `width:${z}px;height:${z}px;top:${Math.random()*60}%;left:${Math.random()*100}%;--d:${(Math.random()*3+1.5).toFixed(1)}s;`;
        c.appendChild(s);
    }
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AUDIO ENGINE  (Web Audio API â€” no files)
   iOS FIX: AudioContext created & unlocked
   on first direct user tap. All ticks are
   pre-scheduled via audio clock (not setInterval)
   so iOS doesn't block them.
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let audioCtx = null;
let audioUnlocked = false;

function getCtx() {
    if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }
    return audioCtx;
}

/* Called on very first tap â€” plays a silent buffer to unlock iOS audio */
function unlockAudio() {
    if (audioUnlocked) return;
    audioUnlocked = true;

    const ctx = getCtx();

    // Play a silent 1-frame buffer â€” this is the iOS unlock trick
    const silentBuf = ctx.createBuffer(1, 1, ctx.sampleRate);
    const silentSrc = ctx.createBufferSource();
    silentSrc.buffer = silentBuf;
    silentSrc.connect(ctx.destination);
    silentSrc.start(0);

    // Resume if suspended (required on some iOS versions)
    if (ctx.state === 'suspended') {
        ctx.resume();
    }

    // Hide the overlay and start the quiz
    document.getElementById('tap-to-start').classList.add('hidden');
    load();
}

/* Tap overlay â€” fires unlockAudio on first interaction */
document.getElementById('tap-to-start').addEventListener('touchstart', unlockAudio, { once: true });
document.getElementById('tap-to-start').addEventListener('click', unlockAudio, { once: true });

/* Tick â€” tick/tock alternate, accepts an audioContext startTime for pre-scheduling */
let tickPhase = 0;
function playTick(startTime) {
    const ctx = getCtx();
    const now = (startTime !== undefined) ? startTime : ctx.currentTime;
    const isTick = tickPhase === 0;
    tickPhase ^= 1;

    // Impact noise
    const impactLen = Math.floor(ctx.sampleRate * 0.055);
    const impactBuf = ctx.createBuffer(1, impactLen, ctx.sampleRate);
    const impData = impactBuf.getChannelData(0);
    for (let i = 0; i < impactLen; i++) {
        const env = Math.exp(-i / (impactLen * 0.18));
        impData[i] = (Math.random() * 2 - 1) * env;
    }
    const impSrc = ctx.createBufferSource();
    impSrc.buffer = impactBuf;

    const bpf = ctx.createBiquadFilter();
    bpf.type = 'bandpass';
    bpf.frequency.value = isTick ? 1900 : 1200;
    bpf.Q.value = isTick ? 6 : 5;

    const notch = ctx.createBiquadFilter();
    notch.type = 'peaking';
    notch.frequency.value = 3500;
    notch.gain.value = -9;
    notch.Q.value = 2;

    const impGain = ctx.createGain();
    impGain.gain.setValueAtTime(isTick ? 2.2 : 1.8, now);
    impGain.gain.exponentialRampToValueAtTime(0.001, now + 0.055);

    impSrc.connect(bpf);
    bpf.connect(notch);
    notch.connect(impGain);
    impGain.connect(ctx.destination);
    impSrc.start(now);

    // Body tone
    const bodyOsc = ctx.createOscillator();
    bodyOsc.type = 'sine';
    bodyOsc.frequency.setValueAtTime(isTick ? 520 : 370, now);
    bodyOsc.frequency.exponentialRampToValueAtTime(isTick ? 480 : 340, now + 0.06);
    const bodyGain = ctx.createGain();
    bodyGain.gain.setValueAtTime(isTick ? 0.18 : 0.14, now);
    bodyGain.gain.exponentialRampToValueAtTime(0.001, now + 0.07);
    bodyOsc.connect(bodyGain);
    bodyGain.connect(ctx.destination);
    bodyOsc.start(now);
    bodyOsc.stop(now + 0.07);

    // High transient click
    const transLen = Math.floor(ctx.sampleRate * 0.004);
    const transBuf = ctx.createBuffer(1, transLen, ctx.sampleRate);
    const tData = transBuf.getChannelData(0);
    for (let i = 0; i < transLen; i++) {
        tData[i] = (Math.random() * 2 - 1) * (1 - i / transLen);
    }
    const transSrc = ctx.createBufferSource();
    transSrc.buffer = transBuf;
    const hpf = ctx.createBiquadFilter();
    hpf.type = 'highpass';
    hpf.frequency.value = 5000;
    const transGain = ctx.createGain();
    transGain.gain.setValueAtTime(0.9, now);
    transGain.gain.exponentialRampToValueAtTime(0.001, now + 0.004);
    transSrc.connect(hpf);
    hpf.connect(transGain);
    transGain.connect(ctx.destination);
    transSrc.start(now);
}

/* Ding */
function playDing() {
    const ctx = getCtx();
    const now = ctx.currentTime;
    const freqs = [1318.5, 1760, 2217];
    freqs.forEach((freq, i) => {
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.type = 'sine';
        osc.frequency.setValueAtTime(freq, now + i * 0.07);
        gain.gain.setValueAtTime(0, now + i * 0.07);
        gain.gain.linearRampToValueAtTime(0.38, now + i * 0.07 + 0.015);
        gain.gain.exponentialRampToValueAtTime(0.001, now + i * 0.07 + 1.4);
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.start(now + i * 0.07);
        osc.stop(now + i * 0.07 + 1.5);
    });
}

/* Swoosh */
function playSwoosh() {
    const ctx = getCtx();
    const duration = 0.55;
    const now = ctx.currentTime;
    const bufSize = ctx.sampleRate * duration;
    const buf = ctx.createBuffer(1, bufSize, ctx.sampleRate);
    const data = buf.getChannelData(0);
    for (let i = 0; i < bufSize; i++) data[i] = Math.random() * 2 - 1;
    const src = ctx.createBufferSource();
    src.buffer = buf;
    const bpf = ctx.createBiquadFilter();
    bpf.type = 'bandpass';
    bpf.frequency.setValueAtTime(800, now);
    bpf.frequency.linearRampToValueAtTime(200, now + duration);
    bpf.Q.value = 1.5;
    const gain = ctx.createGain();
    gain.gain.setValueAtTime(0, now);
    gain.gain.linearRampToValueAtTime(0.45, now + 0.06);
    gain.gain.exponentialRampToValueAtTime(0.001, now + duration);
    src.connect(bpf);
    bpf.connect(gain);
    gain.connect(ctx.destination);
    src.start(now);
    src.stop(now + duration);
}

/*
 * iOS FIX: startTicking() now pre-schedules ALL 7 ticks
 * using the Web Audio clock (ctx.currentTime + offset).
 * This happens in one synchronous call so iOS doesn't block it.
 * setInterval is only used for the visual countdown â€” not audio.
 */
let scheduledTickTimeouts = [];

function startTicking(audioStartTime) {
    stopTicking();
    tickPhase = 0;
    const ctx = getCtx();
    // Schedule all 7 ticks in advance using audio time
    for (let i = 0; i < 7; i++) {
        const scheduleAt = audioStartTime + i; // one per second
        playTick(scheduleAt);
    }
}

function stopTicking() {
    // Nothing to cancel since Web Audio handles timing internally.
    // We just reset phase for next round.
    tickPhase = 0;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   QUESTIONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const questions = [
    { question: "In Islam, what is the name of the sacred month during which Muslims fast from dawn to sunset?", options: ["Shawwal","Ramadan","Muharram","Rajab"], correctIndex: 1, readTime: 5000 },
    { question: "From what time of day does the fast begin during Ramadan?", options: ["Sunrise","Midnight","Dawn","Noon"], correctIndex: 2, readTime: 5000 },
    { question: "At what time of day do Muslims break their fast during Ramadan?", options: ["Sunset","Afternoon","Midnight","Late morning"], correctIndex: 0, readTime: 5000 },
    { question: "What is the pre-dawn meal eaten before the fast begins called?", options: ["Iftar","Suhoor","Eid","Zakat"], correctIndex: 1, readTime: 5000 },
    { question: "What is the meal called that breaks the fast at sunset?", options: ["Suhoor","Tarawih","Iftar","Hajj"], correctIndex: 2, readTime: 5000 },
    { question: "What phrase is commonly said to wish someone a blessed Ramadan?", options: ["Eid Mubarak","Ramadan Mubarak","Allahu Akbar","SubhanAllah"], correctIndex: 1, readTime: 6000 },
    { question: "What celebration marks the end of Ramadan?", options: ["Eid al-Adha","Laylat al-Qadr","Eid al-Fitr","Mawlid"], correctIndex: 2, readTime: 5000 },
    { question: "Which fruit is traditionally used to break the fast?", options: ["Apple","Banana","Dates","Grapes"], correctIndex: 2, readTime: 5000 },
    { question: "Besides abstaining from food and drink, what are Muslims especially encouraged to increase during Ramadan?", options: ["Shopping","Sleeping","Prayer and good deeds","Traveling"], correctIndex: 2, readTime: 6000 },
    { question: "Ramadan follows which calendar?", options: ["Gregorian calendar","Julian calendar","Islamic lunar calendar","Solar calendar"], correctIndex: 2, readTime: 6000 }
];

/* â”€â”€ State â”€â”€ */
let idx = 0, timerTO, cdInt, clickable = true;

const qEl    = document.getElementById('question');
const opEl   = document.getElementById('options');
const tEl    = document.getElementById('timer');
const cdEl   = document.getElementById('countdown');
const numEl  = document.getElementById('question-number');
const cardEl = document.getElementById('question-container');

/* â”€â”€ Load â”€â”€ */
function load() {
    if (idx >= questions.length) idx = 0;
    numEl.textContent = `Question: ${idx + 1}/10`;
    cardEl.classList.add('enter');

    setTimeout(() => {
        cardEl.classList.remove('enter', 'exit');
        const q = questions[idx];
        qEl.textContent = q.question;

        opEl.innerHTML = '';
        q.options.forEach((o, i) => {
            const b = document.createElement('button');
            b.className = 'option';
            b.textContent = o;
            b.addEventListener('click', () => { if (clickable) check(i); });
            opEl.appendChild(b);
        });

        clickable = false;
        startTimer(q.readTime);
        clickable = true;

    }, 50);
}

/* â”€â”€ Timer â”€â”€ */
function startTimer(pause) {
    tEl.style.transition = 'none';
    tEl.style.width = '100%';
    tEl.classList.add('paused');
    tEl.classList.remove('ending');
    cdEl.classList.add('hidden');
    void tEl.offsetWidth;
    clearTimeout(timerTO);
    clearInterval(cdInt);

    setTimeout(() => {
        const ctx = getCtx();

        tEl.classList.remove('paused');
        tEl.style.transition = 'width 7s linear';
        tEl.style.width = '0%';

        let s = 7;
        cdEl.textContent = s;
        cdEl.classList.remove('hidden');

        // Pre-schedule all ticks from the audio clock perspective
        // so iOS doesn't block them (they're all scheduled in this one call)
        startTicking(ctx.currentTime);

        // Visual-only countdown (setInterval is fine for visuals)
        cdInt = setInterval(() => {
            s--;
            cdEl.textContent = s;
            if (s <= 3) tEl.classList.add('ending');
            if (s <= 0) clearInterval(cdInt);
        }, 1000);

        timerTO = setTimeout(() => {
            if (!clickable) return;
            clickable = false;
            clearInterval(cdInt);
            const correctBtn = document.querySelectorAll('.option')[questions[idx].correctIndex];
            correctBtn.classList.add('correct');
            playDing();
            setTimeout(next, 1500);
        }, 7000);
    }, pause);
}

/* â”€â”€ Answer â”€â”€ */
function check(i) {
    clickable = false;
    clearTimeout(timerTO);
    clearInterval(cdInt);
    const opts = document.querySelectorAll('.option');
    const correct = questions[idx].correctIndex;
    opts[i].classList.add(i === correct ? 'correct' : 'incorrect');
    if (i !== correct) opts[correct].classList.add('correct');
    playDing();
    setTimeout(next, 1500);
}

/* â”€â”€ Next â”€â”€ */
function next() {
    playSwoosh();
    cardEl.classList.add('exit');
    setTimeout(() => { idx++; load(); }, 500);
}

// Note: load() is NOT called on DOMContentLoaded anymore.
// It's called inside unlockAudio() after the user taps,
// which is required for iOS audio to work.
</script>
</body>
</html>
