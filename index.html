<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Opinion Assistant</title>
    <style>
        /*
         * ============================================================================
         * TRADING OPINION ASSISTANT - Styling
         * ============================================================================
         * A single-page web application for analyzing trading signals using
         * Moving Average Crossover and RSI indicators.
         * 
         * NO EXTERNAL DEPENDENCIES - Pure CSS with CSS variables for theming
         * ============================================================================
         */
        
        :root {
            --primary-color: #3b82f6;
            --primary-dark: #2563eb;
            --primary-light: #60a5fa;
            --success-color: #10b981;
            --success-dark: #059669;
            --danger-color: #ef4444;
            --danger-dark: #dc2626;
            --warning-color: #f59e0b;
            --warning-dark: #d97706;
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --bg-elevated: #1e293b;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border-color: #334155;
            --border-light: #475569;
            --shadow: 0 4px 6px rgba(0,0,0,0.4);
            --shadow-lg: 0 20px 50px rgba(0,0,0,0.6);
            --shadow-xl: 0 25px 60px rgba(0,0,0,0.8);
            --glow-primary: 0 0 20px rgba(59,130,246,0.3);
            --glow-success: 0 0 20px rgba(16,185,129,0.3);
            --glow-danger: 0 0 20px rgba(239,68,68,0.3);
            --gradient-primary: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            --gradient-success: linear-gradient(135deg, #10b981 0%, #059669 100%);
            --gradient-danger: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            --gradient-dark: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--bg-secondary);
            color: var(--text-primary);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: var(--bg-primary);
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: var(--shadow);
        }
        
        h1 {
            font-size: 1.75rem;
            margin-bottom: 10px;
            color: var(--primary-color);
        }
        
        .header-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
        }
        
        .mode-toggle {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 30px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: var(--success-color);
        }
        
        input:checked + .slider:before {
            transform: translateX(30px);
        }
        
        .disclaimer-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .disclaimer-content {
            background-color: var(--bg-primary);
            margin: 10% auto;
            padding: 30px;
            border-radius: 12px;
            max-width: 600px;
            box-shadow: var(--shadow-lg);
        }
        
        .disclaimer-content h2 {
            color: var(--danger-color);
            margin-bottom: 20px;
        }
        
        .disclaimer-content ul {
            margin: 20px 0;
            padding-left: 25px;
        }
        
        .disclaimer-content li {
            margin: 10px 0;
        }
        
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .card {
            background: var(--bg-primary);
            padding: 20px;
            border-radius: 8px;
            box-shadow: var(--shadow);
        }
        
        .card h3 {
            margin-bottom: 15px;
            color: var(--primary-color);
            font-size: 1.1rem;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--text-secondary);
        }
        
        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.2s;
        }
        
        button:hover {
            background: #1d4ed8;
        }
        
        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background: var(--text-secondary);
        }
        
        .btn-secondary:hover {
            background: #4b5563;
        }
        
        .btn-success {
            background: var(--success-color);
        }
        
        .btn-success:hover {
            background: #059669;
        }
        
        .btn-danger {
            background: var(--danger-color);
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        canvas {
            width: 100%;
            height: 400px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: white;
        }
        
        .opinion-panel {
            background: var(--bg-primary);
            padding: 25px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            text-align: center;
        }
        
        .opinion-signal {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 15px 0;
        }
        
        .opinion-signal.buy {
            color: var(--success-color);
        }
        
        .opinion-signal.sell {
            color: var(--danger-color);
        }
        
        .opinion-signal.hold {
            color: var(--warning-color);
        }
        
        .confidence-bar {
            width: 100%;
            height: 30px;
            background: var(--bg-secondary);
            border-radius: 15px;
            overflow: hidden;
            margin: 15px 0;
        }
        
        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--danger-color), var(--warning-color), var(--success-color));
            transition: width 0.5s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .explanation-box {
            background: var(--bg-secondary);
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
            text-align: left;
        }
        
        .explanation-box h4 {
            margin-bottom: 10px;
        }
        
        .indicator-values {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 10px 0;
        }
        
        .indicator-item {
            background: white;
            padding: 10px;
            border-radius: 4px;
        }
        
        .indicator-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        .indicator-value {
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--text-primary);
        }
        
        .log-panel {
            background: var(--bg-primary);
            padding: 20px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            max-height: 400px;
            overflow-y: auto;
        }
        
        .log-entry {
            padding: 10px;
            margin-bottom: 10px;
            border-left: 4px solid var(--primary-color);
            background: var(--bg-secondary);
            border-radius: 4px;
        }
        
        .log-entry.buy {
            border-left-color: var(--success-color);
        }
        
        .log-entry.sell {
            border-left-color: var(--danger-color);
        }
        
        .log-timestamp {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        .backtest-results {
            background: var(--bg-primary);
            padding: 20px;
            border-radius: 8px;
            box-shadow: var(--shadow);
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .metric-card {
            background: var(--bg-secondary);
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }
        
        .metric-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }
        
        .metric-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .metric-value.positive {
            color: var(--success-color);
        }
        
        .metric-value.negative {
            color: var(--danger-color);
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow-y: auto;
        }
        
        .modal-content {
            background-color: var(--bg-primary);
            margin: 50px auto;
            padding: 30px;
            border-radius: 12px;
            max-width: 800px;
            box-shadow: var(--shadow-lg);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .close {
            font-size: 28px;
            font-weight: bold;
            color: var(--text-secondary);
            cursor: pointer;
        }
        
        .close:hover {
            color: var(--text-primary);
        }
        
        .settings-group {
            margin-bottom: 20px;
        }
        
        .tooltip {
            position: relative;
            display: inline-block;
            margin-left: 5px;
            cursor: help;
            color: var(--primary-color);
            font-weight: bold;
            width: 18px;
            height: 18px;
            border: 2px solid var(--primary-color);
            border-radius: 50%;
            text-align: center;
            line-height: 14px;
            font-size: 12px;
        }
        
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 250px;
            background-color: #333;
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -125px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 13px;
            line-height: 1.4;
        }
        
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        
        .alert {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        
        .alert-warning {
            background: #fef3c7;
            border-left: 4px solid var(--warning-color);
            color: #92400e;
        }
        
        .alert-danger {
            background: #fee2e2;
            border-left: 4px solid var(--danger-color);
            color: #991b1b;
        }
        
        .alert-info {
            background: #dbeafe;
            border-left: 4px solid var(--primary-color);
            color: #1e40af;
        }
        
        .test-results {
            background: var(--bg-primary);
            padding: 20px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }
        
        .test-pass {
            color: var(--success-color);
        }
        
        .test-fail {
            color: var(--danger-color);
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            h1 {
                font-size: 1.5rem;
            }
            
            .controls-grid {
                grid-template-columns: 1fr;
            }
            
            .header-info {
                flex-direction: column;
                align-items: flex-start;
            }
            
            canvas {
                height: 300px;
            }
            
            .opinion-signal {
                font-size: 2rem;
            }
            
            .modal-content {
                margin: 20px;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- 
    ============================================================================
    TRADING OPINION ASSISTANT - README
    ============================================================================
    
    WHAT THIS APP DOES:
    This is a single-page web application that analyzes trading signals using
    Moving Average Crossover and RSI (Relative Strength Index) indicators.
    It provides Buy/Sell/Hold opinions with explainable reasoning.
    
    HOW TO RUN:
    1. Save this HTML file as "index.html"
    2. Open it in any modern web browser (Chrome, Firefox, Safari, Edge)
    3. Accept the disclaimer to use the app
    4. No installation, no build tools, no external dependencies required
    
    DATA SOURCES:
    - Live Mode: Attempts to fetch from Binance public API (CORS-enabled)
    - Simulated Mode: Uses embedded mock historical data
    - Toggle between modes using the Live/Simulated switch
    
    ALGORITHMS EXPLAINED:
    
    1. Moving Average Crossover:
       - Short MA (default 9 periods): Fast-moving average of closing prices
       - Long MA (default 21 periods): Slow-moving average of closing prices
       - BUY Signal: When Short MA crosses ABOVE Long MA (bullish crossover)
       - SELL Signal: When Short MA crosses BELOW Long MA (bearish crossover)
       - HOLD: No crossover detected
    
    2. RSI (Relative Strength Index):
       - Measures momentum on a 0-100 scale
       - RSI < 30: Oversold (potential buy opportunity)
       - RSI > 70: Overbought (potential sell opportunity)
       - Used to adjust confidence in crossover signals
    
    3. Confidence Calculation:
       - Base confidence from MA separation magnitude
       - Boosted when RSI confirms (oversold + buy, or overbought + sell)
       - Normalized to 0-100% scale
    
    BACKTESTING:
    - Simulates trades based on signals over historical data
    - Assumes no slippage, configurable fees
    - Tracks: Total Return, Max Drawdown, Win Rate, Number of Trades
    - Results are hypothetical and for educational purposes only
    
    CORS & NETWORK ISSUES:
    - If live data fetch fails, app automatically falls back to simulated mode
    - Public Binance API is used (no authentication required)
    - Some networks may block external requests
    
    LIMITATIONS:
    - Indicator-based only (no ML/AI models)
    - Simple moving averages (not weighted or exponential)
    - Backtests assume perfect execution with no slippage
    - Real trading involves fees, slippage, liquidity constraints
    - Past performance does not guarantee future results
    
    DISCLAIMER:
    ‚ö†Ô∏è NOT FINANCIAL ADVICE ‚ö†Ô∏è
    This tool is for educational and informational purposes only.
    Do not use this to make real trading decisions.
    The creator is not responsible for any trading losses.
    Always consult with a qualified financial advisor.
    
    SECURITY:
    - No API keys are requested or stored
    - No user credentials are collected
    - All data processing happens locally in your browser
    - No data is sent to external servers (except public market data API)
    
    ============================================================================
    -->

    <!-- Disclaimer Modal -->
    <div id="disclaimerModal" class="disclaimer-modal">
        <div class="disclaimer-content">
            <h2>‚ö†Ô∏è Important Disclaimer</h2>
            <p><strong>This tool provides informational trading opinions only.</strong></p>
            <ul>
                <li>This is <strong>NOT financial advice</strong></li>
                <li>Do not use this app to place live trades</li>
                <li>All signals are based on historical data and simple algorithms</li>
                <li>Past performance does not guarantee future results</li>
                <li>Trading involves substantial risk of loss</li>
                <li>The developer/provider is not responsible for any trading losses</li>
                <li>Always consult with a qualified financial advisor before making investment decisions</li>
            </ul>
            <p style="margin-top: 20px;"><strong>By clicking "I Understand", you acknowledge that you have read and understood these warnings.</strong></p>
            <button onclick="acceptDisclaimer()" class="btn-danger" style="width: 100%; margin-top: 20px; padding: 15px;">
                I Understand - Continue to App
            </button>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Algorithm Settings</h2>
                <span class="close" onclick="closeSettings()">&times;</span>
            </div>
            <div class="settings-group">
                <label>
                    Short MA Period
                    <span class="tooltip">?
                        <span class="tooltiptext">Number of periods for the fast moving average. Smaller values are more responsive to price changes.</span>
                    </span>
                </label>
                <input type="number" id="shortMAPeriod" value="9" min="2" max="50">
            </div>
            <div class="settings-group">
                <label>
                    Long MA Period
                    <span class="tooltip">?
                        <span class="tooltiptext">Number of periods for the slow moving average. Should be larger than Short MA.</span>
                    </span>
                </label>
                <input type="number" id="longMAPeriod" value="21" min="5" max="200">
            </div>
            <div class="settings-group">
                <label>
                    RSI Period
                    <span class="tooltip">?
                        <span class="tooltiptext">Number of periods for RSI calculation. Standard is 14.</span>
                    </span>
                </label>
                <input type="number" id="rsiPeriod" value="14" min="2" max="50">
            </div>
            <div class="settings-group">
                <label>
                    Backtest Initial Capital ($)
                    <span class="tooltip">?
                        <span class="tooltiptext">Starting capital for backtesting simulations.</span>
                    </span>
                </label>
                <input type="number" id="backtestCapital" value="10000" min="100" step="100">
            </div>
            <div class="settings-group">
                <label>
                    Trading Fee (%)
                    <span class="tooltip">?
                        <span class="tooltiptext">Fee percentage charged per trade (e.g., 0.1 for 0.1% fee).</span>
                    </span>
                </label>
                <input type="number" id="tradingFee" value="0.1" min="0" max="5" step="0.01">
            </div>
            <div class="settings-group">
                <label>
                    Stop Loss (%)
                    <span class="tooltip">?
                        <span class="tooltiptext">Percentage below entry price to automatically exit (not used in current backtest).</span>
                    </span>
                </label>
                <input type="number" id="stopLoss" value="5" min="0" max="50" step="0.5">
            </div>
            <div class="settings-group">
                <label>
                    Take Profit (%)
                    <span class="tooltip">?
                        <span class="tooltiptext">Percentage above entry price to automatically exit (not used in current backtest).</span>
                    </span>
                </label>
                <input type="number" id="takeProfit" value="10" min="0" max="100" step="0.5">
            </div>
            <button onclick="saveSettings()" class="btn-success" style="width: 100%; margin-top: 10px;">
                Save Settings
            </button>
        </div>
    </div>

    <div class="container">
        <!-- Header -->
        <header>
            <h1>üìà Trading Opinion Assistant</h1>
            <div class="alert alert-warning">
                <strong>‚ö†Ô∏è Not Financial Advice</strong> - Use at your own risk. For educational purposes only.
            </div>
            <div class="header-info">
                <div>
                    <strong>Last Updated:</strong> <span id="lastUpdated">--</span>
                </div>
                <div class="mode-toggle">
                    <span>Simulated</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="modeToggle" onchange="toggleMode()">
                        <span class="slider"></span>
                    </label>
                    <span>Live</span>
                    <span id="modeStatus" style="margin-left: 10px; font-weight: bold;">Mode: Simulated</span>
                </div>
            </div>
        </header>

        <!-- Controls -->
        <div class="controls-grid">
            <div class="card">
                <h3>Market Data</h3>
                <div class="form-group">
                    <label>Symbol</label>
                    <input type="text" id="symbolInput" value="BTCUSDT" placeholder="e.g., BTCUSDT, ETHUSDT">
                </div>
                <div class="form-group">
                    <label>Timeframe</label>
                    <select id="timeframeSelect">
                        <option value="1m">1 Minute</option>
                        <option value="5m">5 Minutes</option>
                        <option value="15m">15 Minutes</option>
                        <option value="1h" selected>1 Hour</option>
                        <option value="4h">4 Hours</option>
                        <option value="1d">1 Day</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Data Points</label>
                    <input type="number" id="dataPoints" value="100" min="50" max="1000">
                </div>
            </div>

            <div class="card">
                <h3>Actions</h3>
                <div class="button-group">
                    <button onclick="runAnalysis()" class="btn-success">üîç Run Analysis</button>
                    <button onclick="openSettings()">‚öôÔ∏è Settings</button>
                    <button onclick="runBacktest()">üìä Backtest</button>
                    <button onclick="downloadCSV()">üíæ Download CSV</button>
                    <button onclick="clearLog()">üóëÔ∏è Clear Log</button>
                    <button onclick="runTests()" class="btn-secondary">üß™ Run Tests</button>
                </div>
            </div>
        </div>

        <!-- Chart -->
        <div class="card" style="margin-bottom: 20px;">
            <h3>Price Chart with Indicators</h3>
            <canvas id="chartCanvas"></canvas>
        </div>

        <!-- Opinion Panel -->
        <div class="controls-grid">
            <div class="opinion-panel">
                <h3>Trading Opinion</h3>
                <div class="opinion-signal" id="opinionSignal">--</div>
                <div style="margin: 10px 0;">
                    <strong>Confidence:</strong>
                </div>
                <div class="confidence-bar">
                    <div class="confidence-fill" id="confidenceFill" style="width: 0%">0%</div>
                </div>
                <div class="explanation-box">
                    <h4>Why This Opinion?</h4>
                    <div id="opinionExplanation">Run analysis to see trading opinion...</div>
                    <h4 style="margin-top: 15px;">Indicator Values</h4>
                    <div class="indicator-values" id="indicatorValues">
                        <div class="indicator-item">
                            <div class="indicator-label">Short MA</div>
                            <div class="indicator-value">--</div>
                        </div>
                        <div class="indicator-item">
                            <div class="indicator-label">Long MA</div>
                            <div class="indicator-value">--</div>
                        </div>
                        <div class="indicator-item">
                            <div class="indicator-label">RSI</div>
                            <div class="indicator-value">--</div>
                        </div>
                        <div class="indicator-item">
                            <div class="indicator-label">Price</div>
                            <div class="indicator-value">--</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="log-panel">
                <h3>Decision Log</h3>
                <div id="decisionLog">
                    <p style="color: var(--text-secondary);">No decisions yet. Run an analysis to begin.</p>
                </div>
            </div>
        </div>

        <!-- Backtest Results -->
        <div class="backtest-results" id="backtestResults" style="display: none; margin-top: 20px;">
            <h3>Backtest Results</h3>
            <div class="alert alert-info">
                Backtest assumes no slippage and configurable trading fees. Results are hypothetical and for educational purposes only.
            </div>
            <div class="metrics-grid" id="backtestMetrics"></div>
            <canvas id="equityCanvas" style="margin-top: 20px;"></canvas>
        </div>

        <!-- Test Results -->
        <div class="test-results" id="testResults" style="display: none; margin-top: 20px;">
            <h3>Algorithm Test Results</h3>
            <pre id="testOutput"></pre>
        </div>
    </div>

    <script>
        /*
         * ============================================================================
         * TRADING OPINION ASSISTANT - JavaScript
         * ============================================================================
         * Pure ES6+ JavaScript with no external dependencies
         * ============================================================================
         */

        // ============================================================================
        // MOCK DATA - Sample Historical Data
        // ============================================================================
        const MOCK_DATA = [
            {"timestamp":1698710400000,"open":34250.5,"high":34380.2,"low":34180.0,"close":34320.8,"volume":1250.5},
            {"timestamp":1698714000000,"open":34320.8,"high":34450.0,"low":34290.0,"close":34398.5,"volume":1320.2},
            {"timestamp":1698717600000,"open":34398.5,"high":34520.3,"low":34350.0,"close":34480.2,"volume":1580.8},
            {"timestamp":1698721200000,"open":34480.2,"high":34550.0,"low":34420.5,"close":34515.7,"volume":1450.3},
            {"timestamp":1698724800000,"open":34515.7,"high":34600.0,"low":34480.0,"close":34560.3,"volume":1680.9},
            {"timestamp":1698728400000,"open":34560.3,"high":34650.5,"low":34520.0,"close":34620.8,"volume":1750.4},
            {"timestamp":1698732000000,"open":34620.8,"high":34680.0,"low":34580.5,"close":34650.2,"volume":1420.6},
            {"timestamp":1698735600000,"open":34650.2,"high":34720.3,"low":34620.0,"close":34690.5,"volume":1380.2},
            {"timestamp":1698739200000,"open":34690.5,"high":34750.0,"low":34650.0,"close":34720.8,"volume":1520.7},
            {"timestamp":1698742800000,"open":34720.8,"high":34780.5,"low":34690.0,"close":34755.3,"volume":1650.3},
            {"timestamp":1698746400000,"open":34755.3,"high":34820.0,"low":34720.5,"close":34790.6,"volume":1720.8},
            {"timestamp":1698750000000,"open":34790.6,"high":34850.3,"low":34760.0,"close":34825.4,"volume":1580.5},
            {"timestamp":1698753600000,"open":34825.4,"high":34880.0,"low":34800.0,"close":34860.2,"volume":1480.9},
            {"timestamp":1698757200000,"open":34860.2,"high":34920.5,"low":34830.0,"close":34895.7,"volume":1620.4},
            {"timestamp":1698760800000,"open":34895.7,"high":34950.0,"low":34870.0,"close":34920.3,"volume":1750.6},
            {"timestamp":1698764400000,"open":34920.3,"high":34980.5,"low":34890.0,"close":34955.8,"volume":1680.2},
            {"timestamp":1698768000000,"open":34955.8,"high":35020.0,"low":34930.0,"close":34990.5,"volume":1820.7},
            {"timestamp":1698771600000,"open":34990.5,"high":35050.3,"low":34960.0,"close":35025.2,"volume":1720.3},
            {"timestamp":1698775200000,"open":35025.2,"high":35080.0,"low":34995.0,"close":35055.6,"volume":1580.9},
            {"timestamp":1698778800000,"open":35055.6,"high":35120.5,"low":35030.0,"close":35090.4,"volume":1650.5},
            {"timestamp":1698782400000,"open":35090.4,"high":35150.0,"low":35060.0,"close":35125.8,"volume":1780.2},
            {"timestamp":1698786000000,"open":35125.8,"high":35180.3,"low":35095.0,"close":35155.2,"volume":1620.8},
            {"timestamp":1698789600000,"open":35155.2,"high":35200.0,"low":35120.0,"close":35175.6,"volume":1520.4},
            {"timestamp":1698793200000,"open":35175.6,"high":35220.5,"low":35140.0,"close":35195.3,"volume":1450.7},
            {"timestamp":1698796800000,"open":35195.3,"high":35250.0,"low":35170.0,"close":35220.8,"volume":1680.3},
            {"timestamp":1698800400000,"open":35220.8,"high":35280.5,"low":35190.0,"close":35255.4,"volume":1750.6},
            {"timestamp":1698804000000,"open":35255.4,"high":35300.0,"low":35225.0,"close":35275.2,"volume":1580.9},
            {"timestamp":1698807600000,"open":35275.2,"high":35320.3,"low":35245.0,"close":35295.6,"volume":1420.5},
            {"timestamp":1698811200000,"open":35295.6,"high":35340.0,"low":35260.0,"close":35315.8,"volume":1520.2},
            {"timestamp":1698814800000,"open":35315.8,"high":35360.5,"low":35285.0,"close":35335.4,"volume":1650.7},
            {"timestamp":1698818400000,"open":35335.4,"high":35380.0,"low":35305.0,"close":35355.2,"volume":1720.3},
            {"timestamp":1698822000000,"open":35355.2,"high":35400.3,"low":35325.0,"close":35375.6,"volume":1580.8},
            {"timestamp":1698825600000,"open":35375.6,"high":35420.0,"low":35345.0,"close":35395.4,"volume":1450.4},
            {"timestamp":1698829200000,"open":35395.4,"high":35440.5,"low":35365.0,"close":35415.8,"volume":1620.6},
            {"timestamp":1698832800000,"open":35415.8,"high":35460.0,"low":35385.0,"close":35435.2,"volume":1750.9},
            {"timestamp":1698836400000,"open":35435.2,"high":35480.3,"low":35405.0,"close":35455.6,"volume":1680.2},
            {"timestamp":1698840000000,"open":35455.6,"high":35500.0,"low":35425.0,"close":35475.4,"volume":1520.7},
            {"timestamp":1698843600000,"open":35475.4,"high":35520.5,"low":35445.0,"close":35495.8,"volume":1450.3},
            {"timestamp":1698847200000,"open":35495.8,"high":35540.0,"low":35465.0,"close":35515.2,"volume":1580.8},
            {"timestamp":1698850800000,"open":35515.2,"high":35560.3,"low":35485.0,"close":35535.6,"volume":1720.4},
            {"timestamp":1698854400000,"open":35535.6,"high":35580.0,"low":35505.0,"close":35555.4,"volume":1650.6},
            {"timestamp":1698858000000,"open":35555.4,"high":35600.5,"low":35525.0,"close":35575.8,"volume":1580.2},
            {"timestamp":1698861600000,"open":35575.8,"high":35620.0,"low":35545.0,"close":35595.2,"volume":1450.9},
            {"timestamp":1698865200000,"open":35595.2,"high":35640.3,"low":35565.0,"close":35615.6,"volume":1520.5},
            {"timestamp":1698868800000,"open":35615.6,"high":35660.0,"low":35585.0,"close":35635.4,"volume":1680.7},
            {"timestamp":1698872400000,"open":35635.4,"high":35680.5,"low":35605.0,"close":35655.8,"volume":1750.3},
            {"timestamp":1698876000000,"open":35655.8,"high":35700.0,"low":35625.0,"close":35675.2,"volume":1620.8},
            {"timestamp":1698879600000,"open":35675.2,"high":35720.3,"low":35645.0,"close":35695.6,"volume":1520.4},
            {"timestamp":1698883200000,"open":35695.6,"high":35740.0,"low":35665.0,"close":35715.4,"volume":1450.6},
            {"timestamp":1698886800000,"open":35715.4,"high":35760.5,"low":35685.0,"close":35735.8,"volume":1580.9},
            {"timestamp":1698890400000,"open":35735.8,"high":35780.0,"low":35705.0,"close":35755.2,"volume":1720.2},
            {"timestamp":1698894000000,"open":35755.2,"high":35800.3,"low":35725.0,"close":35775.6,"volume":1650.5},
            {"timestamp":1698897600000,"open":35775.6,"high":35820.0,"low":35745.0,"close":35795.4,"volume":1580.7},
            {"timestamp":1698901200000,"open":35795.4,"high":35840.5,"low":35765.0,"close":35815.8,"volume":1450.3},
            {"timestamp":1698904800000,"open":35815.8,"high":35860.0,"low":35785.0,"close":35835.2,"volume":1520.8},
            {"timestamp":1698908400000,"open":35835.2,"high":35880.3,"low":35805.0,"close":35855.6,"volume":1680.4},
            {"timestamp":1698912000000,"open":35855.6,"high":35900.0,"low":35825.0,"close":35875.4,"volume":1750.6},
            {"timestamp":1698915600000,"open":35875.4,"high":35850.0,"low":35780.0,"close":35810.2,"volume":1820.9},
            {"timestamp":1698919200000,"open":35810.2,"high":35840.0,"low":35720.0,"close":35755.6,"volume":1920.3},
            {"timestamp":1698922800000,"open":35755.6,"high":35780.0,"low":35650.0,"close":35685.4,"volume":2050.7},
            {"timestamp":1698926400000,"open":35685.4,"high":35720.0,"low":35580.0,"close":35615.8,"volume":2180.4},
            {"timestamp":1698930000000,"open":35615.8,"high":35650.0,"low":35520.0,"close":35555.2,"volume":2250.6},
            {"timestamp":1698933600000,"open":35555.2,"high":35580.0,"low":35460.0,"close":35495.6,"volume":2320.8},
            {"timestamp":1698937200000,"open":35495.6,"high":35520.0,"low":35400.0,"close":35435.4,"volume":2450.2},
            {"timestamp":1698940800000,"open":35435.4,"high":35460.0,"low":35340.0,"close":35375.8,"volume":2580.5},
            {"timestamp":1698944400000,"open":35375.8,"high":35400.0,"low":35280.0,"close":35315.2,"volume":2720.7},
            {"timestamp":1698948000000,"open":35315.2,"high":35340.0,"low":35220.0,"close":35255.6,"volume":2850.3},
            {"timestamp":1698951600000,"open":35255.6,"high":35280.0,"low":35160.0,"close":35195.4,"volume":2980.8},
            {"timestamp":1698955200000,"open":35195.4,"high":35220.0,"low":35100.0,"close":35135.8,"volume":3120.4},
            {"timestamp":1698958800000,"open":35135.8,"high":35160.0,"low":35040.0,"close":35075.2,"volume":3250.6},
            {"timestamp":1698962400000,"open":35075.2,"high":35100.0,"low":34980.0,"close":35015.6,"volume":3380.9},
            {"timestamp":1698966000000,"open":35015.6,"high":35040.0,"low":34920.0,"close":34955.4,"volume":3520.2},
            {"timestamp":1698969600000,"open":34955.4,"high":34980.0,"low":34860.0,"close":34895.8,"volume":3650.7},
            {"timestamp":1698973200000,"open":34895.8,"high":34920.0,"low":34800.0,"close":34835.2,"volume":3780.3},
            {"timestamp":1698976800000,"open":34835.2,"high":34920.0,"low":34820.0,"close":34885.6,"volume":3250.8},
            {"timestamp":1698980400000,"open":34885.6,"high":35020.0,"low":34870.0,"close":34975.4,"volume":2980.4},
            {"timestamp":1698984000000,"open":34975.4,"high":35120.0,"low":34960.0,"close":35085.8,"volume":2750.6},
            {"timestamp":1698987600000,"open":35085.8,"high":35220.0,"low":35070.0,"close":35195.2,"volume":2520.9},
            {"timestamp":1698991200000,"open":35195.2,"high":35320.0,"low":35180.0,"close":35285.6,"volume":2350.3},
            {"timestamp":1698994800000,"open":35285.6,"high":35400.0,"low":35270.0,"close":35365.4,"volume":2180.7},
            {"timestamp":1698998400000,"open":35365.4,"high":35480.0,"low":35350.0,"close":35445.8,"volume":2050.2},
            {"timestamp":1699002000000,"open":35445.8,"high":35560.0,"low":35430.0,"close":35525.2,"volume":1920.8},
            {"timestamp":1699005600000,"open":35525.2,"high":35640.0,"low":35510.0,"close":35605.6,"volume":1820.4},
            {"timestamp":1699009200000,"open":35605.6,"high":35720.0,"low":35590.0,"close":35685.4,"volume":1750.6},
            {"timestamp":1699012800000,"open":35685.4,"high":35800.0,"low":35670.0,"close":35765.8,"volume":1680.9},
            {"timestamp":1699016400000,"open":35765.8,"high":35880.0,"low":35750.0,"close":35845.2,"volume":1620.3},
            {"timestamp":1699020000000,"open":35845.2,"high":35920.0,"low":35830.0,"close":35895.6,"volume":1580.7},
            {"timestamp":1699023600000,"open":35895.6,"high":35980.0,"low":35880.0,"close":35945.4,"volume":1520.2},
            {"timestamp":1699027200000,"open":35945.4,"high":36020.0,"low":35930.0,"close":35985.8,"volume":1480.8},
            {"timestamp":1699030800000,"open":35985.8,"high":36080.0,"low":35970.0,"close":36045.2,"volume":1450.4},
            {"timestamp":1699034400000,"open":36045.2,"high":36120.0,"low":36030.0,"close":36095.6,"volume":1420.6},
            {"timestamp":1699038000000,"open":36095.6,"high":36180.0,"low":36080.0,"close":36145.4,"volume":1520.9},
            {"timestamp":1699041600000,"open":36145.4,"high":36220.0,"low":36130.0,"close":36185.8,"volume":1620.3},
            {"timestamp":1699045200000,"open":36185.8,"high":36260.0,"low":36170.0,"close":36225.2,"volume":1720.7},
            {"timestamp":1699048800000,"open":36225.2,"high":36300.0,"low":36210.0,"close":36265.6,"volume":1820.2},
            {"timestamp":1699052400000,"open":36265.6,"high":36340.0,"low":36250.0,"close":36305.4,"volume":1920.8},
            {"timestamp":1699056000000,"open":36305.4,"high":36380.0,"low":36290.0,"close":36345.8,"volume":2020.4},
            {"timestamp":1699059600000,"open":36345.8,"high":36420.0,"low":36330.0,"close":36385.2,"volume":2120.6},
            {"timestamp":1699063200000,"open":36385.2,"high":36460.0,"low":36370.0,"close":36425.6,"volume":2220.9},
            {"timestamp":1699066800000,"open":36425.6,"high":36500.0,"low":36410.0,"close":36465.4,"volume":2320.3},
            {"timestamp":1699070400000,"open":36465.4,"high":36540.0,"low":36450.0,"close":36505.8,"volume":2420.7},
            {"timestamp":1699074000000,"open":36505.8,"high":36580.0,"low":36490.0,"close":36545.2,"volume":2520.2},
            {"timestamp":1699077600000,"open":36545.2,"high":36620.0,"low":36530.0,"close":36585.6,"volume":2620.8}
        ];

        // ============================================================================
        // APPLICATION STATE
        // ============================================================================
        let appState = {
            mode: 'simulated', // 'live' or 'simulated'
            currentData: [],
            disclaimerAccepted: false,
            settings: {
                shortMAPeriod: 9,
                longMAPeriod: 21,
                rsiPeriod: 14,
                backtestCapital: 10000,
                tradingFee: 0.1,
                stopLoss: 5,
                takeProfit: 10
            },
            decisionLog: []
        };

        // ============================================================================
        // DATA PROVIDER - Handles data fetching with fallback
        // ============================================================================
        class DataProvider {
            constructor() {
                this.binanceAPI = 'https://api.binance.com/api/v3/klines';
            }

            /**
             * Fetch price series from live API or fallback to mock data
             * @param {string} symbol - Trading symbol (e.g., BTCUSDT)
             * @param {string} timeframe - Timeframe (e.g., 1h, 1d)
             * @param {number} limit - Number of candles to fetch
             * @returns {Promise<Array>} Array of OHLCV objects
             */
            async fetchPriceSeries(symbol, timeframe, limit = 100) {
                if (appState.mode === 'simulated') {
                    return this.getMockData(limit);
                }

                try {
                    // Attempt to fetch from Binance public API
                    const url = `${this.binanceAPI}?symbol=${symbol}&interval=${timeframe}&limit=${limit}`;
                    const response = await fetch(url);
                    
                    if (!response.ok) {
                        throw new Error(`API returned status ${response.status}`);
                    }

                    const data = await response.json();
                    
                    // Transform Binance data format to our format
                    return data.map(candle => ({
                        timestamp: candle[0],
                        open: parseFloat(candle[1]),
                        high: parseFloat(candle[2]),
                        low: parseFloat(candle[3]),
                        close: parseFloat(candle[4]),
                        volume: parseFloat(candle[5])
                    }));
                } catch (error) {
                    console.error('Live data fetch failed:', error);
                    // Fallback to mock data
                    showAlert('Live data unavailable. Using simulated data.', 'warning');
                    return this.getMockData(limit);
                }
            }

            /**
             * Get mock/historical data
             * @param {number} limit - Number of data points
             * @returns {Array} Mock OHLCV data
             */
            getMockData(limit) {
                // Return the last 'limit' items from mock data
                const startIndex = Math.max(0, MOCK_DATA.length - limit);
                return MOCK_DATA.slice(startIndex);
            }
        }

        // ============================================================================
        // INDICATORS - Technical analysis calculations
        // ============================================================================
        class Indicators {
            /**
             * Calculate Simple Moving Average
             * @param {Array} data - Array of price data
             * @param {number} period - MA period
             * @returns {Array} Array of MA values
             */
            static calculateSMA(data, period) {
                const result = [];
                
                for (let i = 0; i < data.length; i++) {
                    if (i < period - 1) {
                        result.push(null);
                        continue;
                    }
                    
                    let sum = 0;
                    for (let j = 0; j < period; j++) {
                        sum += data[i - j].close;
                    }
                    result.push(sum / period);
                }
                
                return result;
            }

            /**
             * Calculate Relative Strength Index (RSI)
             * Formula: RSI = 100 - (100 / (1 + RS))
             * Where RS = Average Gain / Average Loss over period
             * @param {Array} data - Array of price data
             * @param {number} period - RSI period (typically 14)
             * @returns {Array} Array of RSI values (0-100)
             */
            static calculateRSI(data, period = 14) {
                const result = [];
                const gains = [];
                const losses = [];

                // Calculate price changes
                for (let i = 1; i < data.length; i++) {
                    const change = data[i].close - data[i - 1].close;
                    gains.push(change > 0 ? change : 0);
                    losses.push(change < 0 ? Math.abs(change) : 0);
                }

                // Calculate RSI values
                for (let i = 0; i < data.length; i++) {
                    if (i < period) {
                        result.push(null);
                        continue;
                    }

                    // Calculate average gain and loss
                    let avgGain = 0;
                    let avgLoss = 0;
                    
                    for (let j = 0; j < period; j++) {
                        avgGain += gains[i - 1 - j];
                        avgLoss += losses[i - 1 - j];
                    }
                    
                    avgGain /= period;
                    avgLoss /= period;

                    // Calculate RS and RSI
                    if (avgLoss === 0) {
                        result.push(100);
                    } else {
                        const rs = avgGain / avgLoss;
                        const rsi = 100 - (100 / (1 + rs));
                        result.push(rsi);
                    }
                }

                return result;
            }

            /**
             * Detect crossover events
             * @param {Array} fastMA - Fast moving average
             * @param {Array} slowMA - Slow moving average
             * @returns {string} 'bullish', 'bearish', or 'none'
             */
            static detectCrossover(fastMA, slowMA) {
                const len = fastMA.length;
                if (len < 2) return 'none';

                const currentFast = fastMA[len - 1];
                const currentSlow = slowMA[len - 1];
                const prevFast = fastMA[len - 2];
                const prevSlow = slowMA[len - 2];

                if (currentFast === null || currentSlow === null || 
                    prevFast === null || prevSlow === null) {
                    return 'none';
                }

                // Bullish crossover: fast crosses above slow
                if (prevFast <= prevSlow && currentFast > currentSlow) {
                    return 'bullish';
                }

                // Bearish crossover: fast crosses below slow
                if (prevFast >= prevSlow && currentFast < currentSlow) {
                    return 'bearish';
                }

                return 'none';
            }
        }

        // ============================================================================
        // SIGNAL ENGINE - Generates trading opinions
        // ============================================================================
        class SignalEngine {
            /**
             * Generate trading signal based on indicators
             * @param {Array} data - Price data
             * @param {Array} shortMA - Short moving average
             * @param {Array} longMA - Long moving average
             * @param {Array} rsi - RSI values
             * @returns {Object} Signal object with opinion, confidence, and reasoning
             */
            static generateSignal(data, shortMA, longMA, rsi) {
                const crossover = Indicators.detectCrossover(shortMA, longMA);
                const lastIndex = data.length - 1;
                
                const currentPrice = data[lastIndex].close;
                const currentShortMA = shortMA[lastIndex];
                const currentLongMA = longMA[lastIndex];
                const currentRSI = rsi[lastIndex];

                let opinion = 'HOLD';
                let baseConfidence = 0;
                let reasoning = [];

                // Determine base signal from crossover
                if (crossover === 'bullish') {
                    opinion = 'BUY';
                    baseConfidence = 60;
                    reasoning.push('Bullish crossover detected: Short MA crossed above Long MA');
                } else if (crossover === 'bearish') {
                    opinion = 'SELL';
                    baseConfidence = 60;
                    reasoning.push('Bearish crossover detected: Short MA crossed below Long MA');
                } else {
                    // No crossover - determine based on MA position
                    if (currentShortMA > currentLongMA) {
                        opinion = 'HOLD';
                        baseConfidence = 40;
                        reasoning.push('Short MA above Long MA - Bullish trend but no fresh signal');
                    } else {
                        opinion = 'HOLD';
                        baseConfidence = 40;
                        reasoning.push('Short MA below Long MA - Bearish trend but no fresh signal');
                    }
                }

                // Adjust confidence based on MA separation
                const maSeparation = Math.abs(currentShortMA - currentLongMA) / currentPrice * 100;
                const separationBoost = Math.min(maSeparation * 5, 20);
                baseConfidence += separationBoost;
                reasoning.push(`MA separation: ${maSeparation.toFixed(2)}% (adds ${separationBoost.toFixed(1)}% confidence)`);

                // Adjust confidence based on RSI
                let rsiAdjustment = 0;
                if (currentRSI !== null) {
                    if (opinion === 'BUY' && currentRSI < 30) {
                        rsiAdjustment = 15;
                        reasoning.push(`RSI oversold (${currentRSI.toFixed(1)}) confirms BUY signal (+${rsiAdjustment}%)`);
                    } else if (opinion === 'SELL' && currentRSI > 70) {
                        rsiAdjustment = 15;
                        reasoning.push(`RSI overbought (${currentRSI.toFixed(1)}) confirms SELL signal (+${rsiAdjustment}%)`);
                    } else if (opinion === 'BUY' && currentRSI > 70) {
                        rsiAdjustment = -10;
                        reasoning.push(`RSI overbought (${currentRSI.toFixed(1)}) weakens BUY signal (${rsiAdjustment}%)`);
                    } else if (opinion === 'SELL' && currentRSI < 30) {
                        rsiAdjustment = -10;
                        reasoning.push(`RSI oversold (${currentRSI.toFixed(1)}) weakens SELL signal (${rsiAdjustment}%)`);
                    } else {
                        reasoning.push(`RSI neutral (${currentRSI.toFixed(1)}) - no adjustment`);
                    }
                }

                // Calculate final confidence (0-100 range)
                const finalConfidence = Math.max(0, Math.min(100, baseConfidence + rsiAdjustment));

                return {
                    opinion,
                    confidence: finalConfidence,
                    reasoning: reasoning.join('\n'),
                    indicators: {
                        price: currentPrice,
                        shortMA: currentShortMA,
                        longMA: currentLongMA,
                        rsi: currentRSI,
                        crossover
                    },
                    timestamp: data[lastIndex].timestamp
                };
            }
        }

        // ============================================================================
        // BACKTESTER - Simulates trading based on signals
        // ============================================================================
        class Backtester {
            /**
             * Run backtest simulation
             * @param {Array} data - Historical price data
             * @param {Object} settings - Backtest settings
             * @returns {Object} Backtest results
             */
            static runBacktest(data, settings) {
                const { shortMAPeriod, longMAPeriod, rsiPeriod, backtestCapital, tradingFee } = settings;
                
                // Calculate indicators
                const shortMA = Indicators.calculateSMA(data, shortMAPeriod);
                const longMA = Indicators.calculateSMA(data, longMAPeriod);
                const rsi = Indicators.calculateRSI(data, rsiPeriod);

                let capital = backtestCapital;
                let position = 0; // Number of units held
                let inPosition = false;
                let trades = [];
                let equity = [capital];
                let maxEquity = capital;
                let maxDrawdown = 0;

                // Start after we have enough data for all indicators
                const startIndex = Math.max(shortMAPeriod, longMAPeriod, rsiPeriod);

                for (let i = startIndex; i < data.length - 1; i++) {
                    const signal = SignalEngine.generateSignal(
                        data.slice(0, i + 1),
                        shortMA.slice(0, i + 1),
                        longMA.slice(0, i + 1),
                        rsi.slice(0, i + 1)
                    );

                    const price = data[i].close;
                    const feeMultiplier = 1 - (tradingFee / 100);

                    // Buy signal
                    if (signal.opinion === 'BUY' && !inPosition && signal.confidence > 50) {
                        const buyAmount = capital * feeMultiplier;
                        position = buyAmount / price;
                        inPosition = true;
                        
                        trades.push({
                            type: 'BUY',
                            price,
                            timestamp: data[i].timestamp,
                            confidence: signal.confidence,
                            capital: capital
                        });
                    }
                    // Sell signal
                    else if (signal.opinion === 'SELL' && inPosition && signal.confidence > 50) {
                        capital = position * price * feeMultiplier;
                        const lastTrade = trades[trades.length - 1];
                        const profit = capital - lastTrade.capital;
                        const profitPercent = (profit / lastTrade.capital) * 100;
                        
                        trades.push({
                            type: 'SELL',
                            price,
                            timestamp: data[i].timestamp,
                            confidence: signal.confidence,
                            capital: capital,
                            profit,
                            profitPercent
                        });
                        
                        position = 0;
                        inPosition = false;
                    }

                    // Calculate current equity
                    const currentEquity = inPosition ? position * data[i].close : capital;
                    equity.push(currentEquity);

                    // Track max drawdown
                    if (currentEquity > maxEquity) {
                        maxEquity = currentEquity;
                    }
                    const drawdown = ((maxEquity - currentEquity) / maxEquity) * 100;
                    if (drawdown > maxDrawdown) {
                        maxDrawdown = drawdown;
                    }
                }

                // Close any open position at the end
                if (inPosition) {
                    const lastPrice = data[data.length - 1].close;
                    capital = position * lastPrice * (1 - (tradingFee / 100));
                }

                // Calculate metrics
                const finalCapital = capital;
                const totalReturn = ((finalCapital - backtestCapital) / backtestCapital) * 100;
                const winningTrades = trades.filter((t, i) => t.type === 'SELL' && t.profit > 0).length;
                const losingTrades = trades.filter((t, i) => t.type === 'SELL' && t.profit < 0).length;
                const winRate = trades.filter(t => t.type === 'SELL').length > 0 
                    ? (winningTrades / (winningTrades + losingTrades)) * 100 
                    : 0;

                // Calculate CAGR (approximate based on data duration)
                const durationDays = (data[data.length - 1].timestamp - data[startIndex].timestamp) / (1000 * 60 * 60 * 24);
                const durationYears = durationDays / 365;
                const cagr = durationYears > 0 
                    ? (Math.pow(finalCapital / backtestCapital, 1 / durationYears) - 1) * 100 
                    : 0;

                return {
                    initialCapital: backtestCapital,
                    finalCapital,
                    totalReturn,
                    maxDrawdown,
                    trades: trades.filter(t => t.type === 'SELL').length,
                    winningTrades,
                    losingTrades,
                    winRate,
                    cagr,
                    equity,
                    tradeLog: trades
                };
            }
        }

        // ============================================================================
        // CHART RENDERER - Canvas-based charting
        // ============================================================================
        class ChartRenderer {
            /**
             * Draw price chart with indicators
             * @param {string} canvasId - Canvas element ID
             * @param {Array} data - Price data
             * @param {Array} shortMA - Short moving average
             * @param {Array} longMA - Long moving average
             */
            static drawChart(canvasId, data, shortMA, longMA) {
                const canvas = document.getElementById(canvasId);
                const ctx = canvas.getContext('2d');
                
                // Set canvas size
                canvas.width = canvas.offsetWidth;
                canvas.height = canvas.offsetHeight;

                const width = canvas.width;
                const height = canvas.height;
                const padding = 40;

                // Clear canvas
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, width, height);

                if (data.length === 0) return;

                // Calculate price range
                const prices = data.map(d => d.close);
                const highs = data.map(d => d.high);
                const lows = data.map(d => d.low);
                const maxPrice = Math.max(...highs);
                const minPrice = Math.min(...lows);
                const priceRange = maxPrice - minPrice;

                // Helper function to convert price to Y coordinate
                const priceToY = (price) => {
                    return padding + (height - 2 * padding) * (1 - (price - minPrice) / priceRange);
                };

                // Helper function to convert index to X coordinate
                const indexToX = (index) => {
                    return padding + (width - 2 * padding) * (index / (data.length - 1));
                };

                // Draw grid
                ctx.strokeStyle = '#e5e7eb';
                ctx.lineWidth = 1;
                for (let i = 0; i < 5; i++) {
                    const y = padding + (height - 2 * padding) * (i / 4);
                    ctx.beginPath();
                    ctx.moveTo(padding, y);
                    ctx.lineTo(width - padding, y);
                    ctx.stroke();

                    // Price labels
                    const price = maxPrice - (priceRange * i / 4);
                    ctx.fillStyle = '#6b7280';
                    ctx.font = '12px sans-serif';
                    ctx.textAlign = 'right';
                    ctx.fillText(price.toFixed(2), padding - 5, y + 4);
                }

                // Draw candlesticks
                for (let i = 0; i < data.length; i++) {
                    const x = indexToX(i);
                    const openY = priceToY(data[i].open);
                    const closeY = priceToY(data[i].close);
                    const highY = priceToY(data[i].high);
                    const lowY = priceToY(data[i].low);

                    const isGreen = data[i].close >= data[i].open;
                    ctx.strokeStyle = isGreen ? '#10b981' : '#ef4444';
                    ctx.fillStyle = isGreen ? '#10b981' : '#ef4444';

                    // Draw wick
                    ctx.beginPath();
                    ctx.moveTo(x, highY);
                    ctx.lineTo(x, lowY);
                    ctx.stroke();

                    // Draw body
                    const bodyHeight = Math.abs(closeY - openY);
                    const bodyY = Math.min(openY, closeY);
                    ctx.fillRect(x - 2, bodyY, 4, Math.max(bodyHeight, 1));
                }

                // Draw Short MA
                ctx.strokeStyle = '#3b82f6';
                ctx.lineWidth = 2;
                ctx.beginPath();
                let firstPoint = true;
                for (let i = 0; i < shortMA.length; i++) {
                    if (shortMA[i] !== null) {
                        const x = indexToX(i);
                        const y = priceToY(shortMA[i]);
                        if (firstPoint) {
                            ctx.moveTo(x, y);
                            firstPoint = false;
                        } else {
                            ctx.lineTo(x, y);
                        }
                    }
                }
                ctx.stroke();

                // Draw Long MA
                ctx.strokeStyle = '#f59e0b';
                ctx.lineWidth = 2;
                ctx.beginPath();
                firstPoint = true;
                for (let i = 0; i < longMA.length; i++) {
                    if (longMA[i] !== null) {
                        const x = indexToX(i);
                        const y = priceToY(longMA[i]);
                        if (firstPoint) {
                            ctx.moveTo(x, y);
                            firstPoint = false;
                        } else {
                            ctx.lineTo(x, y);
                        }
                    }
                }
                ctx.stroke();

                // Draw legend
                ctx.fillStyle = '#111827';
                ctx.font = 'bold 14px sans-serif';
                ctx.textAlign = 'left';
                ctx.fillText('Price', padding + 10, padding - 10);
                
                ctx.fillStyle = '#3b82f6';
                ctx.fillText(`Short MA (${appState.settings.shortMAPeriod})`, padding + 60, padding - 10);
                
                ctx.fillStyle = '#f59e0b';
                ctx.fillText(`Long MA (${appState.settings.longMAPeriod})`, padding + 160, padding - 10);
            }

            /**
             * Draw equity curve for backtest
             * @param {string} canvasId - Canvas element ID
             * @param {Array} equity - Equity values over time
             */
            static drawEquityCurve(canvasId, equity) {
                const canvas = document.getElementById(canvasId);
                const ctx = canvas.getContext('2d');
                
                canvas.width = canvas.offsetWidth;
                canvas.height = canvas.offsetHeight;

                const width = canvas.width;
                const height = canvas.height;
                const padding = 40;

                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, width, height);

                if (equity.length === 0) return;

                const maxEquity = Math.max(...equity);
                const minEquity = Math.min(...equity);
                const equityRange = maxEquity - minEquity;

                const equityToY = (value) => {
                    return padding + (height - 2 * padding) * (1 - (value - minEquity) / equityRange);
                };

                const indexToX = (index) => {
                    return padding + (width - 2 * padding) * (index / (equity.length - 1));
                };

                // Draw grid
                ctx.strokeStyle = '#e5e7eb';
                ctx.lineWidth = 1;
                for (let i = 0; i < 5; i++) {
                    const y = padding + (height - 2 * padding) * (i / 4);
                    ctx.beginPath();
                    ctx.moveTo(padding, y);
                    ctx.lineTo(width - padding, y);
                    ctx.stroke();

                    const value = maxEquity - (equityRange * i / 4);
                    ctx.fillStyle = '#6b7280';
                    ctx.font = '12px sans-serif';
                    ctx.textAlign = 'right';
                    ctx.fillText(' + value.toFixed(0), padding - 5, y + 4);
                }

                // Draw equity curve
                ctx.strokeStyle = '#10b981';
                ctx.lineWidth = 3;
                ctx.beginPath();
                for (let i = 0; i < equity.length; i++) {
                    const x = indexToX(i);
                    const y = equityToY(equity[i]);
                    if (i === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                }
                ctx.stroke();

                // Draw title
                ctx.fillStyle = '#111827';
                ctx.font = 'bold 14px sans-serif';
                ctx.textAlign = 'left';
                ctx.fillText('Equity Curve', padding + 10, padding - 10);
            }
        }

        // ============================================================================
        // UI CONTROLLER - Manages user interface
        // ============================================================================
        class UIController {
            static updateLastUpdated() {
                const now = new Date();
                document.getElementById('lastUpdated').textContent = now.toLocaleString();
            }

            static updateOpinion(signal) {
                const opinionEl = document.getElementById('opinionSignal');
                opinionEl.textContent = signal.opinion;
                opinionEl.className = 'opinion-signal ' + signal.opinion.toLowerCase();

                const confidenceFill = document.getElementById('confidenceFill');
                confidenceFill.style.width = signal.confidence + '%';
                confidenceFill.textContent = signal.confidence.toFixed(1) + '%';

                const explanationEl = document.getElementById('opinionExplanation');
                explanationEl.innerHTML = '<p>' + signal.reasoning.replace(/\n/g, '</p><p>') + '</p>';

                // Update indicator values
                const indicatorsHTML = `
                    <div class="indicator-item">
                        <div class="indicator-label">Short MA</div>
                        <div class="indicator-value">${signal.indicators.shortMA?.toFixed(2) || '--'}</div>
                    </div>
                    <div class="indicator-item">
                        <div class="indicator-label">Long MA</div>
                        <div class="indicator-value">${signal.indicators.longMA?.toFixed(2) || '--'}</div>
                    </div>
                    <div class="indicator-item">
                        <div class="indicator-label">RSI</div>
                        <div class="indicator-value">${signal.indicators.rsi?.toFixed(2) || '--'}</div>
                    </div>
                    <div class="indicator-item">
                        <div class="indicator-label">Price</div>
                        <div class="indicator-value">${signal.indicators.price?.toFixed(2) || '--'}</div>
                    </div>
                `;
                document.getElementById('indicatorValues').innerHTML = indicatorsHTML;
            }

            static addToLog(signal) {
                const logEntry = {
                    timestamp: signal.timestamp,
                    opinion: signal.opinion,
                    confidence: signal.confidence,
                    indicators: signal.indicators,
                    reasoning: signal.reasoning
                };

                appState.decisionLog.unshift(logEntry);
                
                // Keep only last 20 entries
                if (appState.decisionLog.length > 20) {
                    appState.decisionLog = appState.decisionLog.slice(0, 20);
                }

                this.renderLog();
            }

            static renderLog() {
                const logContainer = document.getElementById('decisionLog');
                
                if (appState.decisionLog.length === 0) {
                    logContainer.innerHTML = '<p style="color: var(--text-secondary);">No decisions yet. Run an analysis to begin.</p>';
                    return;
                }

                const logHTML = appState.decisionLog.map(entry => {
                    const date = new Date(entry.timestamp);
                    return `
                        <div class="log-entry ${entry.opinion.toLowerCase()}">
                            <div class="log-timestamp">${date.toLocaleString()}</div>
                            <div><strong>${entry.opinion}</strong> - Confidence: ${entry.confidence.toFixed(1)}%</div>
                            <div style="font-size: 0.9rem; margin-top: 5px;">
                                Short MA: ${entry.indicators.shortMA?.toFixed(2) || 'N/A'} | 
                                Long MA: ${entry.indicators.longMA?.toFixed(2) || 'N/A'} | 
                                RSI: ${entry.indicators.rsi?.toFixed(2) || 'N/A'}
                            </div>
                        </div>
                    `;
                }).join('');

                logContainer.innerHTML = logHTML;
            }

            static showBacktestResults(results) {
                const resultsContainer = document.getElementById('backtestResults');
                resultsContainer.style.display = 'block';

                const metricsHTML = `
                    <div class="metric-card">
                        <div class="metric-label">Initial Capital</div>
                        <div class="metric-value">${results.initialCapital.toFixed(2)}</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Final Capital</div>
                        <div class="metric-value ${results.finalCapital > results.initialCapital ? 'positive' : 'negative'}">
                            ${results.finalCapital.toFixed(2)}
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Total Return</div>
                        <div class="metric-value ${results.totalReturn > 0 ? 'positive' : 'negative'}">
                            ${results.totalReturn.toFixed(2)}%
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Max Drawdown</div>
                        <div class="metric-value negative">-${results.maxDrawdown.toFixed(2)}%</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Total Trades</div>
                        <div class="metric-value">${results.trades}</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Win Rate</div>
                        <div class="metric-value">${results.winRate.toFixed(1)}%</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Winning Trades</div>
                        <div class="metric-value positive">${results.winningTrades}</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Losing Trades</div>
                        <div class="metric-value negative">${results.losingTrades}</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">CAGR</div>
                        <div class="metric-value ${results.cagr > 0 ? 'positive' : 'negative'}">
                            ${results.cagr.toFixed(2)}%
                        </div>
                    </div>
                `;

                document.getElementById('backtestMetrics').innerHTML = metricsHTML;
                ChartRenderer.drawEquityCurve('equityCanvas', results.equity);
            }
        }

        // ============================================================================
        // EVENT HANDLERS
        // ============================================================================

        function acceptDisclaimer() {
            appState.disclaimerAccepted = true;
            document.getElementById('disclaimerModal').style.display = 'none';
        }

        function toggleMode() {
            const toggle = document.getElementById('modeToggle');
            appState.mode = toggle.checked ? 'live' : 'simulated';
            document.getElementById('modeStatus').textContent = 'Mode: ' + (toggle.checked ? 'Live' : 'Simulated');
        }

        async function runAnalysis() {
            if (!appState.disclaimerAccepted) {
                showAlert('Please accept the disclaimer first.', 'danger');
                return;
            }

            try {
                const symbol = document.getElementById('symbolInput').value.toUpperCase();
                const timeframe = document.getElementById('timeframeSelect').value;
                const dataPoints = parseInt(document.getElementById('dataPoints').value);

                // Fetch data
                const dataProvider = new DataProvider();
                const data = await dataProvider.fetchPriceSeries(symbol, timeframe, dataPoints);
                appState.currentData = data;

                // Calculate indicators
                const shortMA = Indicators.calculateSMA(data, appState.settings.shortMAPeriod);
                const longMA = Indicators.calculateSMA(data, appState.settings.longMAPeriod);
                const rsi = Indicators.calculateRSI(data, appState.settings.rsiPeriod);

                // Generate signal
                const signal = SignalEngine.generateSignal(data, shortMA, longMA, rsi);

                // Update UI
                UIController.updateOpinion(signal);
                UIController.addToLog(signal);
                UIController.updateLastUpdated();

                // Draw chart
                ChartRenderer.drawChart('chartCanvas', data, shortMA, longMA);

                showAlert('Analysis complete!', 'info');
            } catch (error) {
                console.error('Analysis error:', error);
                showAlert('Analysis failed: ' + error.message, 'danger');
            }
        }

        async function runBacktest() {
            if (!appState.disclaimerAccepted) {
                showAlert('Please accept the disclaimer first.', 'danger');
                return;
            }

            if (appState.currentData.length === 0) {
                showAlert('Please run an analysis first to load data.', 'warning');
                return;
            }

            try {
                const results = Backtester.runBacktest(appState.currentData, appState.settings);
                UIController.showBacktestResults(results);
                showAlert('Backtest complete!', 'info');
            } catch (error) {
                console.error('Backtest error:', error);
                showAlert('Backtest failed: ' + error.message, 'danger');
            }
        }

        function openSettings() {
            document.getElementById('settingsModal').style.display = 'block';
        }

        function closeSettings() {
            document.getElementById('settingsModal').style.display = 'none';
        }

        function saveSettings() {
            appState.settings.shortMAPeriod = parseInt(document.getElementById('shortMAPeriod').value);
            appState.settings.longMAPeriod = parseInt(document.getElementById('longMAPeriod').value);
            appState.settings.rsiPeriod = parseInt(document.getElementById('rsiPeriod').value);
            appState.settings.backtestCapital = parseFloat(document.getElementById('backtestCapital').value);
            appState.settings.tradingFee = parseFloat(document.getElementById('tradingFee').value);
            appState.settings.stopLoss = parseFloat(document.getElementById('stopLoss').value);
            appState.settings.takeProfit = parseFloat(document.getElementById('takeProfit').value);

            closeSettings();
            showAlert('Settings saved!', 'info');
        }

        function downloadCSV() {
            if (appState.currentData.length === 0) {
                showAlert('No data to download. Run an analysis first.', 'warning');
                return;
            }

            let csv = 'Timestamp,Date,Open,High,Low,Close,Volume\n';
            appState.currentData.forEach(row => {
                const date = new Date(row.timestamp).toISOString();
                csv += `${row.timestamp},${date},${row.open},${row.high},${row.low},${row.close},${row.volume}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'trading_data_' + Date.now() + '.csv';
            a.click();
            window.URL.revokeObjectURL(url);

            showAlert('CSV downloaded!', 'info');
        }

        function clearLog() {
            appState.decisionLog = [];
            UIController.renderLog();
            showAlert('Log cleared!', 'info');
        }

        function runTests() {
            const testOutput = document.getElementById('testOutput');
            const testResults = document.getElementById('testResults');
            testResults.style.display = 'block';

            let output = '=== ALGORITHM TESTS ===\n\n';

            // Test 1: SMA Calculation
            output += 'Test 1: Simple Moving Average Calculation\n';
            const testData = [
                { close: 10 }, { close: 20 }, { close: 30 }, { close: 40 }, { close: 50 }
            ];
            const sma = Indicators.calculateSMA(testData, 3);
            const expectedSMA = [null, null, 20, 30, 40];
            const smaPass = JSON.stringify(sma) === JSON.stringify(expectedSMA);
            output += `Expected: [null, null, 20, 30, 40]\n`;
            output += `Got: [${sma.join(', ')}]\n`;
            output += smaPass ? '‚úì PASS\n\n' : '‚úó FAIL\n\n';

            // Test 2: RSI Calculation
            output += 'Test 2: RSI Calculation\n';
            const rsiTestData = [];
            for (let i = 0; i < 20; i++) {
                rsiTestData.push({ close: 100 + Math.sin(i) * 10 });
            }
            const rsi = Indicators.calculateRSI(rsiTestData, 14);
            const lastRSI = rsi[rsi.length - 1];
            const rsiPass = lastRSI !== null && lastRSI >= 0 && lastRSI <= 100;
            output += `Last RSI value: ${lastRSI?.toFixed(2) || 'null'}\n`;
            output += `Valid range (0-100): ${rsiPass}\n`;
            output += rsiPass ? '‚úì PASS\n\n' : '‚úó FAIL\n\n';

            // Test 3: Crossover Detection
            output += 'Test 3: Crossover Detection\n';
            const fastMA = [10, 15, 20, 25];
            const slowMA = [20, 20, 20, 20];
            const crossover = Indicators.detectCrossover(fastMA, slowMA);
            const crossoverPass = crossover === 'bullish';
            output += `Fast MA crosses above Slow MA\n`;
            output += `Expected: bullish\n`;
            output += `Got: ${crossover}\n`;
            output += crossoverPass ? '‚úì PASS\n\n' : '‚úó FAIL\n\n';

            // Test 4: Signal Generation
            output += 'Test 4: Signal Generation\n';
            const signalTestData = MOCK_DATA.slice(0, 50);
            const signalShortMA = Indicators.calculateSMA(signalTestData, 9);
            const signalLongMA = Indicators.calculateSMA(signalTestData, 21);
            const signalRSI = Indicators.calculateRSI(signalTestData, 14);
            const signal = SignalEngine.generateSignal(signalTestData, signalShortMA, signalLongMA, signalRSI);
            const signalPass = ['BUY', 'SELL', 'HOLD'].includes(signal.opinion) && 
                               signal.confidence >= 0 && signal.confidence <= 100;
            output += `Opinion: ${signal.opinion}\n`;
            output += `Confidence: ${signal.confidence.toFixed(2)}%\n`;
            output += `Valid output: ${signalPass}\n`;
            output += signalPass ? '‚úì PASS\n\n' : '‚úó FAIL\n\n';

            output += '=== ALL TESTS COMPLETE ===\n';

            testOutput.textContent = output;
            showAlert('Tests complete! Check results below.', 'info');
        }

        function showAlert(message, type) {
            // Simple alert implementation
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        // ============================================================================
        // INITIALIZATION
        // ============================================================================

        window.addEventListener('load', () => {
            // Show disclaimer on first load
            document.getElementById('disclaimerModal').style.display = 'block';

            // Initialize settings from state
            document.getElementById('shortMAPeriod').value = appState.settings.shortMAPeriod;
            document.getElementById('longMAPeriod').value = appState.settings.longMAPeriod;
            document.getElementById('rsiPeriod').value = appState.settings.rsiPeriod;
            document.getElementById('backtestCapital').value = appState.settings.backtestCapital;
            document.getElementById('tradingFee').value = appState.settings.tradingFee;
            document.getElementById('stopLoss').value = appState.settings.stopLoss;
            document.getElementById('takeProfit').value = appState.settings.takeProfit;

            // Close modals when clicking outside
            window.onclick = (event) => {
                const settingsModal = document.getElementById('settingsModal');
                if (event.target === settingsModal) {
                    closeSettings();
                }
            };
        });
    </script>
</body>
</html>
